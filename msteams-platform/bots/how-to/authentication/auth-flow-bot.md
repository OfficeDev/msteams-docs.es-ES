---
title: Microsoft Teams Flujo de autenticación para bots
description: Describe Microsoft Teams de autenticación en bots
keywords: bots de flujo de autenticación de teams
localization_priority: Normal
ms.topic: overview
ms.openlocfilehash: 68ba2024d0e0f2f92a52e93614e4576dcde8dcbc
ms.sourcegitcommit: 14409950307b135265c8582408be5277b35131dd
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 06/17/2021
ms.locfileid: "52994227"
---
# <a name="authentication-flow-for-bots-in-microsoft-teams"></a><span data-ttu-id="5449c-104">Flujo de autenticación para bots en Microsoft Teams</span><span class="sxs-lookup"><span data-stu-id="5449c-104">Authentication flow for bots in Microsoft Teams</span></span>

<span data-ttu-id="5449c-105">OAuth 2.0 es un estándar abierto para la autenticación y autorización usado por Azure Active Directory (Azure AD) y otros muchos proveedores de identidad.</span><span class="sxs-lookup"><span data-stu-id="5449c-105">OAuth 2.0 is an open standard for authentication and authorization used by Azure Active Directory (Azure AD) and many other identity providers.</span></span> <span data-ttu-id="5449c-106">Un conocimiento básico de OAuth 2.0 es un requisito previo para trabajar con la autenticación en Teams; [esta es una buena introducción](https://aaronparecki.com/oauth-2-simplified/) que es más fácil de seguir que la [especificación formal](https://oauth.net/2/).</span><span class="sxs-lookup"><span data-stu-id="5449c-106">A basic understanding of OAuth 2.0 is a prerequisite for working with authentication in Teams; [here's a good overview](https://aaronparecki.com/oauth-2-simplified/) that's easier to follow than the [formal specification](https://oauth.net/2/).</span></span> <span data-ttu-id="5449c-107">El flujo de autenticación para pestañas y bots es un poco diferente: las pestañas son muy similares a los sitios web para que puedan usar OAuth 2.0 directamente, mientras que los bots no son y deben hacer algunas cosas de forma diferente, pero los conceptos básicos son idénticos.</span><span class="sxs-lookup"><span data-stu-id="5449c-107">Authentication flow for tabs and bots is a little different — tabs are very similar to websites so they can use OAuth 2.0 directly, while bots aren't and must do a few things differently — but the core concepts are identical.</span></span>

<span data-ttu-id="5449c-108">Consulte el ejemplo Microsoft Teams [](https://github.com/OfficeDev/Microsoft-Teams-Samples/tree/main/samples/app-auth/nodejs) de autenticación de repositorio de GitHub para ver un ejemplo que muestra el flujo de autenticación para bots que usan Node.js y el tipo de concesión de código de autorización [de OAuth 2.0](https://oauth.net/2/grant-types/authorization-code/).</span><span class="sxs-lookup"><span data-stu-id="5449c-108">See the GitHub repo [Microsoft Teams Authentication Sample](https://github.com/OfficeDev/Microsoft-Teams-Samples/tree/main/samples/app-auth/nodejs) for an example that demonstrates authentication flow for bots using Node.js and the [OAuth 2.0 authorization code grant type](https://oauth.net/2/grant-types/authorization-code/).</span></span>

![Diagrama de secuencia de autenticación de bot](../../../assets/images/authentication/bot_auth_sequence_diagram.png)

1. <span data-ttu-id="5449c-110">El usuario envía un mensaje al bot.</span><span class="sxs-lookup"><span data-stu-id="5449c-110">The user sends a message to the bot.</span></span>
2. <span data-ttu-id="5449c-111">El bot determina si el usuario debe iniciar sesión.</span><span class="sxs-lookup"><span data-stu-id="5449c-111">The bot determines if the user needs to sign in.</span></span>
   <span data-ttu-id="5449c-112">En este ejemplo, el bot almacena el token de acceso en su almacén de datos de usuario.</span><span class="sxs-lookup"><span data-stu-id="5449c-112">In this example, the bot stores the access token in its user data store.</span></span> <span data-ttu-id="5449c-113">Se pide al usuario que inicie sesión si no tiene un token validado para el proveedor de identidades seleccionado.</span><span class="sxs-lookup"><span data-stu-id="5449c-113">It asks the user to sign in if it doesn't have a validated token for the selected identity provider.</span></span> <span data-ttu-id="5449c-114">([Ver código](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/utils/AuthenticationUtils.ts#L58-L76))</span><span class="sxs-lookup"><span data-stu-id="5449c-114">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/utils/AuthenticationUtils.ts#L58-L76))</span></span>
3. <span data-ttu-id="5449c-115">El bot construye la dirección URL en la página de inicio del flujo de autenticación y envía una tarjeta al usuario con una `signin` acción.</span><span class="sxs-lookup"><span data-stu-id="5449c-115">The bot constructs the URL to the start page of the authentication flow, and sends a card to the user with a `signin` action.</span></span> <span data-ttu-id="5449c-116">([Ver código](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L160-L190))</span><span class="sxs-lookup"><span data-stu-id="5449c-116">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L160-L190))</span></span></br>
    <span data-ttu-id="5449c-117">Al igual que otros flujos de autenticación de aplicación en Teams, la página de inicio debe estar en un dominio que esté en la lista y en el mismo dominio que la página de redireccionamiento posterior `validDomains` al inicio de sesión.</span><span class="sxs-lookup"><span data-stu-id="5449c-117">Like other application auth flows in Teams, the start page must be in a domain that's on your `validDomains` list, and in the same domain as the post-login redirect page.</span></span>
    > [!IMPORTANT] 
    > <span data-ttu-id="5449c-118">El flujo de concesión de código de autorización de OAuth 2.0 llama a un parámetro de la solicitud de autenticación que contiene un token de sesión único para evitar un ataque de falsificación de solicitudes `state` [entre sitios.](https://en.wikipedia.org/wiki/Cross-site_request_forgery)</span><span class="sxs-lookup"><span data-stu-id="5449c-118">The OAuth 2.0 authorization code grant flow calls for a `state` parameter in the authentication request which contains a unique session token to prevent a [cross-site request forgery attack](https://en.wikipedia.org/wiki/Cross-site_request_forgery).</span></span> <span data-ttu-id="5449c-119">En el ejemplo se usa un GUID generado aleatoriamente.</span><span class="sxs-lookup"><span data-stu-id="5449c-119">The example uses a randomly-generated GUID.</span></span>
4. <span data-ttu-id="5449c-120">Cuando el usuario selecciona el botón *de* inicio de sesión, Teams abre una ventana emergente y navega a la página de inicio.</span><span class="sxs-lookup"><span data-stu-id="5449c-120">When the user selects the *signin* button, Teams opens a popup window and navigates to the start page.</span></span>
   > [!NOTE]
   > <span data-ttu-id="5449c-121">El tamaño de la ventana emergente se puede controlar mediante parámetros de cadena de consulta de ancho y alto en la dirección URL.</span><span class="sxs-lookup"><span data-stu-id="5449c-121">The size of the pop-up window can be controlled through width and height query string parameters in the URL.</span></span> <span data-ttu-id="5449c-122">Por ejemplo, si agrega width=600 y height=600, el tamaño de la ventana emergente es de 600 x 600 píxeles.</span><span class="sxs-lookup"><span data-stu-id="5449c-122">For example, if you add width=600 and height=600, the size of the pop-up window is 600x600 pixels.</span></span> <span data-ttu-id="5449c-123">El tamaño real de la ventana emergente se recueste como un porcentaje del Teams de la ventana principal.</span><span class="sxs-lookup"><span data-stu-id="5449c-123">The actual size of the pop-up window is capped as a percentage of the Teams main window size.</span></span> <span data-ttu-id="5449c-124">Si la Teams es pequeña, la ventana emergente es menor que las dimensiones especificadas.</span><span class="sxs-lookup"><span data-stu-id="5449c-124">If the Teams window is small, the pop-up window is smaller than the specified dimensions.</span></span>

5. <span data-ttu-id="5449c-125">La página de inicio redirige al usuario al extremo del proveedor de `authorize` identidades.</span><span class="sxs-lookup"><span data-stu-id="5449c-125">The start page redirects the user to the identity provider's `authorize` endpoint.</span></span> <span data-ttu-id="5449c-126">([Ver código](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/public/html/auth-start.html#L51-L56))</span><span class="sxs-lookup"><span data-stu-id="5449c-126">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/public/html/auth-start.html#L51-L56))</span></span>
6. <span data-ttu-id="5449c-127">En el sitio del proveedor, el usuario inicia sesión y concede acceso al bot.</span><span class="sxs-lookup"><span data-stu-id="5449c-127">On the provider's site, the user signs in and grants access to the bot.</span></span>
7. <span data-ttu-id="5449c-128">El proveedor lleva al usuario a la página de redireccionamiento de OAuth del bot con un código de autorización.</span><span class="sxs-lookup"><span data-stu-id="5449c-128">The provider takes the user to the bot's OAuth redirect page with an authorization code.</span></span>
8. <span data-ttu-id="5449c-129">El bot canjea el código de autorización de un token de acceso y **asocia provisionalmente** el token con el usuario que inició el flujo de inicio de sesión.</span><span class="sxs-lookup"><span data-stu-id="5449c-129">The bot redeems the authorization code for an access token, and **provisionally** associates the token with the user that initiated the sign-in flow.</span></span> <span data-ttu-id="5449c-130">A continuación, le llamamos un *token provisional*.</span><span class="sxs-lookup"><span data-stu-id="5449c-130">Below, we call this a *provisional token*.</span></span>
    * <span data-ttu-id="5449c-131">En el ejemplo, el bot asocia el valor del parámetro con el identificador del usuario que inició el proceso de inicio de sesión para que posteriormente pueda coincidir con el valor devuelto por el proveedor de `state` `state` identidades.</span><span class="sxs-lookup"><span data-stu-id="5449c-131">In the example, the bot associates the value of the `state` parameter with the ID of the user that initiated the sign-in process so it can later match it with the `state` value returned by the identity provider.</span></span> <span data-ttu-id="5449c-132">([Ver código](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L70-L99))</span><span class="sxs-lookup"><span data-stu-id="5449c-132">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L70-L99))</span></span>
      > [!IMPORTANT] 
      > <span data-ttu-id="5449c-133">El bot almacena el token que recibe del proveedor de identidades y lo asocia con un usuario específico, pero se marca como "validación pendiente".</span><span class="sxs-lookup"><span data-stu-id="5449c-133">The bot stores the token it receives from the identity provider and associates it with a specific user, but it is marked as "pending validation".</span></span> 
    * <span data-ttu-id="5449c-134">El token provisional no se puede usar sin una validación adicional.</span><span class="sxs-lookup"><span data-stu-id="5449c-134">The provisional token can't be used without further validation.</span></span>
      1. <span data-ttu-id="5449c-135">**Valide lo que se recibe del proveedor de identidades.**</span><span class="sxs-lookup"><span data-stu-id="5449c-135">**Validate what's received from the identity provider.**</span></span> <span data-ttu-id="5449c-136">El valor del `state` parámetro debe confirmarse con respecto a lo que se guardó anteriormente.</span><span class="sxs-lookup"><span data-stu-id="5449c-136">The value of the `state` parameter must be confirmed against what was saved earlier.</span></span> 
      1. <span data-ttu-id="5449c-137">**Valide lo que se recibe de Teams.**</span><span class="sxs-lookup"><span data-stu-id="5449c-137">**Validate what's received from Teams.**</span></span> <span data-ttu-id="5449c-138">Se [realiza una validación de](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) autenticación en dos pasos para garantizar que el usuario que autorizó el bot con el proveedor de identidades sea el mismo usuario que está chateando con el bot.</span><span class="sxs-lookup"><span data-stu-id="5449c-138">A [two-step authentication](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) validation is performed to ensure that the user who authorized the bot with the identity provider is the same user who is chatting with the bot.</span></span> <span data-ttu-id="5449c-139">Esto protege contra ataques de suplantación de identidad [(phishing) y](https://en.wikipedia.org/wiki/Phishing) de [man-in-the-middle.](https://en.wikipedia.org/wiki/Man-in-the-middle_attack)</span><span class="sxs-lookup"><span data-stu-id="5449c-139">This guards against [man-in-the-middle](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) and [phishing](https://en.wikipedia.org/wiki/Phishing) attacks.</span></span> <span data-ttu-id="5449c-140">El bot genera un código de verificación y lo almacena, asociado con el usuario.</span><span class="sxs-lookup"><span data-stu-id="5449c-140">The bot generates a verification code and stores it, associated with the user.</span></span> <span data-ttu-id="5449c-141">El código de verificación se envía automáticamente Teams como se describe a continuación.</span><span class="sxs-lookup"><span data-stu-id="5449c-141">The verification code is sent automatically by Teams as described below.</span></span> <span data-ttu-id="5449c-142">([Ver código](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L100-L113))</span><span class="sxs-lookup"><span data-stu-id="5449c-142">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L100-L113))</span></span>
9. <span data-ttu-id="5449c-143">La devolución de llamada de OAuth representa una página que llama a `notifySuccess("<verification code>")` .</span><span class="sxs-lookup"><span data-stu-id="5449c-143">The OAuth callback renders a page that calls `notifySuccess("<verification code>")`.</span></span> <span data-ttu-id="5449c-144">([Ver código](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/master/src/views/oauth-callback-success.hbs))</span><span class="sxs-lookup"><span data-stu-id="5449c-144">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/master/src/views/oauth-callback-success.hbs))</span></span>
10. <span data-ttu-id="5449c-145">Teams cierra la ventana emergente y envía el envío al `<verification code>` `notifySuccess()` bot.</span><span class="sxs-lookup"><span data-stu-id="5449c-145">Teams closes the pop-up window and sends the `<verification code>` sent to `notifySuccess()` back to the bot.</span></span> <span data-ttu-id="5449c-146">El bot recibe un [mensaje de invocación](/bot-framework/dotnet/bot-builder-dotnet-activities#invoke) con `name = signin/verifyState` .</span><span class="sxs-lookup"><span data-stu-id="5449c-146">The bot receives an [invoke](/bot-framework/dotnet/bot-builder-dotnet-activities#invoke) message with `name = signin/verifyState`.</span></span>
11. <span data-ttu-id="5449c-147">El bot comprueba el código de comprobación entrante con el código de verificación almacenado con el token provisional del usuario.</span><span class="sxs-lookup"><span data-stu-id="5449c-147">The bot checks the incoming verification code against the verification code stored with the user's provisional token.</span></span> <span data-ttu-id="5449c-148">([Ver código](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L127-L140))</span><span class="sxs-lookup"><span data-stu-id="5449c-148">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L127-L140))</span></span>
12. <span data-ttu-id="5449c-149">Si coinciden, el bot marca el token como validado y listo para su uso.</span><span class="sxs-lookup"><span data-stu-id="5449c-149">If they match, the bot marks the token as validated and ready for use.</span></span> <span data-ttu-id="5449c-150">De lo contrario, se produce un error en el flujo de autenticación y el bot elimina el token provisional.</span><span class="sxs-lookup"><span data-stu-id="5449c-150">Otherwise, the auth flow fails, and the bot deletes the provisional token.</span></span>

    > [!NOTE]
    > <span data-ttu-id="5449c-151">Si tiene problemas con la autenticación en dispositivos móviles, asegúrese de que el SDK de JavaScript se actualice a la versión 1.4.1 o posterior.</span><span class="sxs-lookup"><span data-stu-id="5449c-151">If you experience issues with authentication on mobile, ensure your JavaScript SDK is updated to version 1.4.1 or later.</span></span>

## <a name="code-sample"></a><span data-ttu-id="5449c-152">Ejemplo de código</span><span class="sxs-lookup"><span data-stu-id="5449c-152">Code sample</span></span>

<span data-ttu-id="5449c-153">Código de ejemplo que muestra el proceso de autenticación del bot:</span><span class="sxs-lookup"><span data-stu-id="5449c-153">Sample code showing the bot authentication process:</span></span>

| <span data-ttu-id="5449c-154">**Nombre de ejemplo**</span><span class="sxs-lookup"><span data-stu-id="5449c-154">**Sample name**</span></span> | <span data-ttu-id="5449c-155">**Descripción**</span><span class="sxs-lookup"><span data-stu-id="5449c-155">**Description**</span></span> | <span data-ttu-id="5449c-156">**Node.js**</span><span class="sxs-lookup"><span data-stu-id="5449c-156">**Node.js**</span></span> | <span data-ttu-id="5449c-157">**.NET**</span><span class="sxs-lookup"><span data-stu-id="5449c-157">**.NET**</span></span> | <span data-ttu-id="5449c-158">**Python**</span><span class="sxs-lookup"><span data-stu-id="5449c-158">**Python**</span></span> |
|-----------------|----------------|--------------|----------|-----------|
| <span data-ttu-id="5449c-159">Teams autenticación</span><span class="sxs-lookup"><span data-stu-id="5449c-159">Teams authentication</span></span> | <span data-ttu-id="5449c-160">En este ejemplo se muestra la autenticación en Microsoft Teams aplicaciones.</span><span class="sxs-lookup"><span data-stu-id="5449c-160">This sample demonstrates authentication in Microsoft Teams apps.</span></span> | [<span data-ttu-id="5449c-161">View</span><span class="sxs-lookup"><span data-stu-id="5449c-161">View</span></span>](https://github.com/OfficeDev/microsoft-teams-sample-auth-node) | | |
| <span data-ttu-id="5449c-162">Autenticación de bot</span><span class="sxs-lookup"><span data-stu-id="5449c-162">Bot authentication</span></span> | <span data-ttu-id="5449c-163">En este ejemplo se muestra cómo usar la autenticación para un bot que se ejecuta en Microsoft Teams</span><span class="sxs-lookup"><span data-stu-id="5449c-163">This sample demonstartes how to use authentication for a bot runnning in Microsoft Teams</span></span> | [<span data-ttu-id="5449c-164">View</span><span class="sxs-lookup"><span data-stu-id="5449c-164">View</span></span>](https://github.com/microsoft/BotBuilder-Samples/tree/main/samples/javascript_nodejs/46.teams-auth) | [<span data-ttu-id="5449c-165">View</span><span class="sxs-lookup"><span data-stu-id="5449c-165">View</span></span>](https://github.com/microsoft/BotBuilder-Samples/tree/main/samples/csharp_dotnetcore/46.teams-auth) | [<span data-ttu-id="5449c-166">View</span><span class="sxs-lookup"><span data-stu-id="5449c-166">View</span></span>](https://github.com/microsoft/BotBuilder-Samples/tree/main/samples/python/46.teams-auth)

## <a name="see-also"></a><span data-ttu-id="5449c-167">Ver también</span><span class="sxs-lookup"><span data-stu-id="5449c-167">See also</span></span>

[<span data-ttu-id="5449c-168">Agregar autenticación al bot Teams usuario</span><span class="sxs-lookup"><span data-stu-id="5449c-168">Add authentication to your Teams bot</span></span>](add-authentication.md)
