---
title: Flujo de autenticación de Microsoft Teams para bots
description: Describe el flujo de autenticación de Microsoft Teams en bots
keywords: bots de flujo de autenticación de Teams
ms.topic: overview
ms.openlocfilehash: b9e72a0e1064779d9a2e49deda24e5e2eaed5962
ms.sourcegitcommit: aca9990e1f84b07b9e77c08bfeca4440eb4e64f0
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 11/25/2020
ms.locfileid: "49409088"
---
# <a name="authentication-flow-for-bots-in-microsoft-teams"></a><span data-ttu-id="42418-104">Flujo de autenticación para bots en Microsoft Teams</span><span class="sxs-lookup"><span data-stu-id="42418-104">Authentication flow for bots in Microsoft Teams</span></span>

<span data-ttu-id="42418-105">OAuth 2,0 es un estándar abierto para la autenticación y autorización usado por Azure Active Directory (Azure AD) y muchos otros proveedores de identidades.</span><span class="sxs-lookup"><span data-stu-id="42418-105">OAuth 2.0 is an open standard for authentication and authorization used by Azure Active Directory (Azure AD) and many other identity providers.</span></span> <span data-ttu-id="42418-106">Una descripción básica de OAuth 2,0 es un requisito previo para trabajar con la autenticación en Microsoft Teams. [esta es una buena introducción](https://aaronparecki.com/oauth-2-simplified/) que es más fácil de seguir que la [especificación formal](https://oauth.net/2/).</span><span class="sxs-lookup"><span data-stu-id="42418-106">A basic understanding of OAuth 2.0 is a prerequisite for working with authentication in Teams; [here's a good overview](https://aaronparecki.com/oauth-2-simplified/) that's easier to follow than the [formal specification](https://oauth.net/2/).</span></span> <span data-ttu-id="42418-107">El flujo de autenticación para fichas y bots es un poco diferente: las pestañas son muy similares a los sitios web para que puedan usar OAuth 2,0 directamente, mientras que los bots no son y deben hacer algunas cosas de manera diferente, pero los conceptos básicos son idénticos.</span><span class="sxs-lookup"><span data-stu-id="42418-107">Authentication flow for tabs and bots is a little different — tabs are very similar to websites so they can use OAuth 2.0 directly, while bots aren't and must do a few things differently — but the core concepts are identical.</span></span>

<span data-ttu-id="42418-108">Consulte el repositorio de GitHub [ejemplo de autenticación de Microsoft Teams](https://github.com/OfficeDev/microsoft-teams-sample-auth-node) para obtener un ejemplo que muestra el flujo de autenticación para bots con Node.js y el [tipo de concesión de código de autorización de OAuth 2,0](https://oauth.net/2/grant-types/authorization-code/).</span><span class="sxs-lookup"><span data-stu-id="42418-108">See the GitHub repo [Microsoft Teams Authentication Sample](https://github.com/OfficeDev/microsoft-teams-sample-auth-node) for an example that demonstrates authentication flow for bots using Node.js and the [OAuth 2.0 authorization code grant type](https://oauth.net/2/grant-types/authorization-code/).</span></span>

![Diagrama de secuencia de autenticación de bot](../../../assets/images/authentication/bot_auth_sequence_diagram.png)

1. <span data-ttu-id="42418-110">El usuario envía un mensaje al bot.</span><span class="sxs-lookup"><span data-stu-id="42418-110">The user sends a message to the bot.</span></span>
2. <span data-ttu-id="42418-111">El bot determina si el usuario tiene que iniciar sesión.</span><span class="sxs-lookup"><span data-stu-id="42418-111">The bot determines if the user needs to sign in.</span></span>
    * <span data-ttu-id="42418-112">En este ejemplo, el bot almacena el token de acceso en su almacén de datos de usuario.</span><span class="sxs-lookup"><span data-stu-id="42418-112">In this example, the bot stores the access token in its user data store.</span></span> <span data-ttu-id="42418-113">Pide al usuario que inicie sesión si no tiene un token validado para el proveedor de identidad seleccionado.</span><span class="sxs-lookup"><span data-stu-id="42418-113">It asks the user to sign in if it doesn't have a validated token for the selected identity provider.</span></span> <span data-ttu-id="42418-114">([Código de vista](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/utils/AuthenticationUtils.ts#L58-L76))</span><span class="sxs-lookup"><span data-stu-id="42418-114">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/utils/AuthenticationUtils.ts#L58-L76))</span></span>
3. <span data-ttu-id="42418-115">El bot crea la dirección URL de la página de inicio del flujo de autenticación y envía una tarjeta al usuario con una `signin` acción.</span><span class="sxs-lookup"><span data-stu-id="42418-115">The bot constructs the URL to the start page of the authentication flow, and sends a card to the user with a `signin` action.</span></span> <span data-ttu-id="42418-116">([Código de vista](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L160-L190))</span><span class="sxs-lookup"><span data-stu-id="42418-116">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L160-L190))</span></span>
    * <span data-ttu-id="42418-117">Al igual que otros flujos de autenticación de aplicaciones en Microsoft Teams, la página de inicio debe estar en un dominio que se encuentra en la `validDomains` lista y en el mismo dominio que la página de redireccionamiento posterior al inicio de sesión.</span><span class="sxs-lookup"><span data-stu-id="42418-117">Like other application auth flows in Teams, the start page must be in a domain that's on your `validDomains` list, and in the same domain as the post-login redirect page.</span></span>
    * <span data-ttu-id="42418-118">**Importante**: el flujo de concesión de código de autorización de OAuth 2,0 llama `state` a un parámetro en la solicitud de autenticación que contiene un token de sesión único para evitar un [ataque de falsificación de solicitud entre sitios](https://en.wikipedia.org/wiki/Cross-site_request_forgery).</span><span class="sxs-lookup"><span data-stu-id="42418-118">**IMPORTANT**: The OAuth 2.0 authorization code grant flow calls for a `state` parameter in the authentication request which contains a unique session token to prevent a [cross-site request forgery attack](https://en.wikipedia.org/wiki/Cross-site_request_forgery).</span></span> <span data-ttu-id="42418-119">En el ejemplo se usa un GUID generado aleatoriamente.</span><span class="sxs-lookup"><span data-stu-id="42418-119">The example uses a randomly-generated GUID.</span></span>
4. <span data-ttu-id="42418-120">Cuando el usuario selecciona el botón de inicio de *sesión* , Microsoft Teams abre una ventana emergente y se desplaza a la página de inicio.</span><span class="sxs-lookup"><span data-stu-id="42418-120">When the user selects the *signin* button, Teams opens a popup window and navigates to the start page.</span></span>
> [!NOTE]
> <span data-ttu-id="42418-121">El tamaño de la ventana emergente se puede controlar mediante los parámetros de cadena de consulta width y height en la dirección URL.</span><span class="sxs-lookup"><span data-stu-id="42418-121">The size of the pop-up window can be controlled through width and height query string parameters in the URL.</span></span> <span data-ttu-id="42418-122">Por ejemplo, si agrega width = 500 y height = 500, obtendrá un elemento emergente de 500x500 píxeles.</span><span class="sxs-lookup"><span data-stu-id="42418-122">For example if you add width=500 and height=500, you'll get a popup that's 500x500 pixels.</span></span> <span data-ttu-id="42418-123">Microsoft Teams mostrará la ventana emergente con el tamaño de píxel dado, hasta un máximo que sea un porcentaje del tamaño de la ventana principal.</span><span class="sxs-lookup"><span data-stu-id="42418-123">Teams will show the pop-up window with the given pixel size, up to a maximum that's a percentage of the size of the main window.</span></span>
5. <span data-ttu-id="42418-124">La página de inicio redirige al usuario al punto de conexión del proveedor de identidades `authorize` .</span><span class="sxs-lookup"><span data-stu-id="42418-124">The start page redirects the user to the identity provider's `authorize` endpoint.</span></span> <span data-ttu-id="42418-125">([Código de vista](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/public/html/auth-start.html#L51-L56))</span><span class="sxs-lookup"><span data-stu-id="42418-125">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/public/html/auth-start.html#L51-L56))</span></span>
6. <span data-ttu-id="42418-126">En el sitio del proveedor, el usuario inicia sesión y concede acceso al bot.</span><span class="sxs-lookup"><span data-stu-id="42418-126">On the provider's site, the user signs in and grants access to the bot.</span></span>
7. <span data-ttu-id="42418-127">El proveedor lleva al usuario a la página de redireccionamiento de OAuth del bot con un código de autorización.</span><span class="sxs-lookup"><span data-stu-id="42418-127">The provider takes the user to the bot's OAuth redirect page with an authorization code.</span></span>
8. <span data-ttu-id="42418-128">El bot canjea el código de autorización para un token de acceso y, de forma **provisional** , asocia el token con el usuario que inició el flujo de inicio de sesión.</span><span class="sxs-lookup"><span data-stu-id="42418-128">The bot redeems the authorization code for an access token, and **provisionally** associates the token with the user that initiated the sign-in flow.</span></span> <span data-ttu-id="42418-129">A continuación, se denomina un *token provisional*.</span><span class="sxs-lookup"><span data-stu-id="42418-129">Below, we call this a *provisional token*.</span></span>
    * <span data-ttu-id="42418-130">En el ejemplo, el bot asocia el valor del `state` parámetro con el identificador del usuario que inició el proceso de inicio de sesión para que más adelante pueda hacerlo con el `state` valor devuelto por el proveedor de identidad.</span><span class="sxs-lookup"><span data-stu-id="42418-130">In the example, the bot associates the value of the `state` parameter with the ID of the user that initiated the sign-in process so it can later match it with the `state` value returned by the identity provider.</span></span> <span data-ttu-id="42418-131">([Código de vista](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L70-L99))</span><span class="sxs-lookup"><span data-stu-id="42418-131">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L70-L99))</span></span>
    * <span data-ttu-id="42418-132">**Importante**: el bot almacena el token que recibe del proveedor de identidad y lo asocia a un usuario específico, pero se marca como "pendiente de validación".</span><span class="sxs-lookup"><span data-stu-id="42418-132">**IMPORTANT**: The bot stores the token it receives from the identity provider and associates it with a specific user, but it is marked as "pending validation".</span></span> <span data-ttu-id="42418-133">El token provisional no se puede usar todavía; debe validarse aún más:</span><span class="sxs-lookup"><span data-stu-id="42418-133">The provisional token can't be used yet; it must be further validated:</span></span>
      1. <span data-ttu-id="42418-134">**Validar lo que se recibe del proveedor de identidades.**</span><span class="sxs-lookup"><span data-stu-id="42418-134">**Validate what's received from the identity provider.**</span></span> <span data-ttu-id="42418-135">El valor del `state` parámetro debe confirmarse con respecto a lo que se guardó anteriormente.</span><span class="sxs-lookup"><span data-stu-id="42418-135">The value of the `state` parameter must be confirmed against what was saved earlier.</span></span> 
      1. <span data-ttu-id="42418-136">**Validar lo que se recibe de Microsoft Teams.**</span><span class="sxs-lookup"><span data-stu-id="42418-136">**Validate what's received from Teams.**</span></span> <span data-ttu-id="42418-137">Se realiza una validación de [autenticación en dos pasos](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) para garantizar que el usuario que ha autorizado el bot con el proveedor de identidades es el mismo usuario que está conversando con el bot.</span><span class="sxs-lookup"><span data-stu-id="42418-137">A [two-step authentication](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) validation is performed to ensure that the user who authorized the bot with the identity provider is the same user who is chatting with the bot.</span></span> <span data-ttu-id="42418-138">Esto protege contra ataques [de "Man in the Middle](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) " y de [suplantación de identidad (phishing)](https://en.wikipedia.org/wiki/Phishing) .</span><span class="sxs-lookup"><span data-stu-id="42418-138">This guards against [man-in-the-middle](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) and [phishing](https://en.wikipedia.org/wiki/Phishing) attacks.</span></span> <span data-ttu-id="42418-139">El bot genera un código de comprobación y lo almacena, asociado al usuario.</span><span class="sxs-lookup"><span data-stu-id="42418-139">The bot generates a verification code and stores it, associated with the user.</span></span> <span data-ttu-id="42418-140">Los equipos envían automáticamente el código de comprobación como se describe a continuación.</span><span class="sxs-lookup"><span data-stu-id="42418-140">The verification code is sent automatically by Teams as described below.</span></span> <span data-ttu-id="42418-141">([Código de vista](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L100-L113))</span><span class="sxs-lookup"><span data-stu-id="42418-141">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L100-L113))</span></span>
9. <span data-ttu-id="42418-142">La devolución de llamada de OAuth representa una página que llama `notifySuccess("<verification code>")` .</span><span class="sxs-lookup"><span data-stu-id="42418-142">The OAuth callback renders a page that calls `notifySuccess("<verification code>")`.</span></span> <span data-ttu-id="42418-143">([Código de vista](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/master/src/views/oauth-callback-success.hbs))</span><span class="sxs-lookup"><span data-stu-id="42418-143">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/master/src/views/oauth-callback-success.hbs))</span></span>
10. <span data-ttu-id="42418-144">Microsoft Teams cierra la ventana emergente y envía el mensaje `<verification code>` que se envía de `notifySuccess()` vuelta al bot.</span><span class="sxs-lookup"><span data-stu-id="42418-144">Teams closes the pop-up window and sends the `<verification code>` sent to `notifySuccess()` back to the bot.</span></span> <span data-ttu-id="42418-145">El bot recibe un mensaje de [invocación](/bot-framework/dotnet/bot-builder-dotnet-activities#invoke) con `name = signin/verifyState` .</span><span class="sxs-lookup"><span data-stu-id="42418-145">The bot receives an [invoke](/bot-framework/dotnet/bot-builder-dotnet-activities#invoke) message with `name = signin/verifyState`.</span></span>
11. <span data-ttu-id="42418-146">El bot comprueba el código de comprobación entrante con el código de comprobación almacenado con el token provisional del usuario.</span><span class="sxs-lookup"><span data-stu-id="42418-146">The bot checks the incoming verification code against the verification code stored with the user's provisional token.</span></span> <span data-ttu-id="42418-147">([Código de vista](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L127-L140))</span><span class="sxs-lookup"><span data-stu-id="42418-147">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L127-L140))</span></span>
12. <span data-ttu-id="42418-148">Si coinciden, el bot marca el token como validado y listo para su uso.</span><span class="sxs-lookup"><span data-stu-id="42418-148">If they match, the bot marks the token as validated and ready for use.</span></span> <span data-ttu-id="42418-149">De lo contrario, se produce un error en el flujo de autenticación y el bot elimina el token provisional.</span><span class="sxs-lookup"><span data-stu-id="42418-149">Otherwise, the auth flow fails, and the bot deletes the provisional token.</span></span>

> [!NOTE]
> <span data-ttu-id="42418-150">Si experimenta problemas con la autenticación en dispositivos móviles, asegúrese de que el SDK de JavaScript se haya actualizado a la versión 1.4.1 o posterior.</span><span class="sxs-lookup"><span data-stu-id="42418-150">If you experience issues with authentication on mobile, ensure your JavaScript SDK is updated to version 1.4.1 or later.</span></span>

## <a name="samples"></a><span data-ttu-id="42418-151">Ejemplos</span><span class="sxs-lookup"><span data-stu-id="42418-151">Samples</span></span>

<span data-ttu-id="42418-152">Para ver el código de ejemplo que muestra el proceso de autenticación de bot, consulte:</span><span class="sxs-lookup"><span data-stu-id="42418-152">For sample code showing the bot authentication process see:</span></span>

* [<span data-ttu-id="42418-153">Ejemplo de autenticación de bot de Microsoft Teams (Node.js)</span><span class="sxs-lookup"><span data-stu-id="42418-153">Microsoft Teams bot authentication sample (Node.js)</span></span>](https://github.com/OfficeDev/microsoft-teams-sample-auth-node)

## <a name="more-details"></a><span data-ttu-id="42418-154">Más detalles</span><span class="sxs-lookup"><span data-stu-id="42418-154">More details</span></span>

<span data-ttu-id="42418-155">Para ver los tutoriales de implementación detallados para la autenticación de bot dirigidas a Azure AD vea:</span><span class="sxs-lookup"><span data-stu-id="42418-155">For detailed implementation walkthroughs for bot authentication targeting Azure AD see:</span></span>

* [<span data-ttu-id="42418-156">Agregar autenticación a su bot de Teams</span><span class="sxs-lookup"><span data-stu-id="42418-156">Add authentication to your Teams bot</span></span>](add-authentication.md)
